name: CI/CD

on:
  push:
    branches: 
      - main
      - release
  pull_request:
    branches: 
      - main
      - release

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        api: [HotelInformationAPI, RoomReservationAPI, UserRegistrationAPI] # Les noms des dossiers ou des projets pour chaque API

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: '7.x' # Assurez-vous que c'est la version de .NET que vous utilisez

    - name: Install dependencies
      run: dotnet restore ${{ matrix.api }}.sln # Restaurer les dépendances pour chaque API

    - name: Build
      run: dotnet build ${{ matrix.api }}.sln --no-restore # Construire chaque API

    - name: Run tests
      run: dotnet test ${{ matrix.api }}.sln --no-build --verbosity normal # Exécuter les tests pour chaque API

  deploy:
    if: github.ref == 'refs/heads/release' || github.ref == 'refs/heads/production'
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: '7.x'

    - name: Publish to Azure
      env:
        AZURE_WEBAPP_NAME: clean-architecture 
        AZURE_RESOURCE_GROUP: clean-archi
        AZURE_PUBLISH_PROFILE: ${{ secrets.TEST_SECRET }} # Assurez-vous d'ajouter votre profil de publication en tant que secret GitHub
      run: |
        for api in HotelInformationAPI, RoomReservationAPI, UserRegistrationAPI; do
          dotnet publish $api/$api.csproj -c Release -o $api/publish
          az webapp deploy --name $AZURE_WEBAPP_NAME --resource-group $AZURE_RESOURCE_GROUP --src-path $api/publish
        done
